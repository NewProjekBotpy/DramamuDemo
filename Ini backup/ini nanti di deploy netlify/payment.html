<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Beli VIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="https://app.sandbox.midtrans.com/snap/snap.js" 
            data-client-key="Mid-client-w1beNF94k6-rmQHM"></script> <style>
        body { background-color: #0d1117; color: #c9d1d9; }
        .paket-vip { background-color: #161b22; border-color: #30363d; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-md mx-auto">
        <h1 class="text-xl font-bold text-white mb-4">Pilih Paket VIP Kamu</h1>

        <div class="space-y-4">
            <div class="paket-vip p-4 rounded-lg border">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="font-bold text-white text-lg">1 Hari</h2>
                        <p class="text-sm text-gray-400">VIP 1 Hari</p>
                    </div>
                    <button onclick="beliPaket(1, 2000, 'VIP 1 Hari')"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">
                        Rp 2.000
                    </button>
                </div>
            </div>

            <div class="paket-vip p-4 rounded-lg border">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="font-bold text-white text-lg">3 Hari</h2>
                        <p class="text-sm text-gray-400">VIP 3 Hari</p>
                    </div>
                    <button onclick="beliPaket(2, 5000, 'VIP 3 Hari')"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">
                        Rp 5.000
                    </button>
                </div>
            </div>

            <div class="paket-vip p-4 rounded-lg border">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="font-bold text-white text-lg">7 Hari</h2>
                        <p class="text-sm text-gray-400">VIP 7 Hari</p>
                    </div>
                    <button onclick="beliPaket(3, 10000, 'VIP 7 Hari')"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">
                        Rp 10.000
                    </button>
                </div>
            </div>

            </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        const user = tg.initDataUnsafe?.user;
        const telegram_id = user ? user.id : 123456789; // (Fallback ID buat tes di browser)

        async function beliPaket(paketId, harga, namaPaket) {
            console.log(`Mencoba beli: ${namaPaket} (Rp ${harga})`);

            const paymentData = {
                telegram_id: telegram_id,
                paket_id: paketId,
                gross_amount: harga,
                nama_paket: namaPaket
            };

            try {
                // 1. Panggil API backend lu (main.py) untuk minta token Snap
                // ⚠️ GANTI '127.0.0.1' DENGAN URL PUBLIK BACKEND LU NANTI
                const response = await fetch('https://dramamu-api.onrender.com/api/v1/create_payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentData)
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'Gagal bikin token Snap');
                }

                const data = await response.json();
                const snapToken = data.snap_token;

                // 2. Kalo token-nya dapet, buka pop-up Midtrans
                snap.pay(snapToken, {
                    onSuccess: function(result){
                        alert('Pembayaran sukses! Kamu sekarang VIP.');
                        tg.close(); // Tutup Mini App
                    },
                    onPending: function(result){
                        alert('Pembayaran ditunda (misal: nunggu transfer).');
                    },
                    onError: function(result){
                        alert('Pembayaran Gagal!');
                    }
                });

            } catch (error) {
                console.error('Error pas manggil API pembayaran:', error);
                alert(`Gagal konek ke server pembayaran: ${error.message}`);
            }
        }
    </script>
</body>
</html>